<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCADA Widget 本地测试</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #1a1a2e; color: #fff; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 300px; background: #16213e; padding: 20px; overflow-y: auto; }
    .main { flex: 1; padding: 20px; }
    #widget-container { 
      width: 100%; 
      height: calc(100vh - 140px); 
      background: #0f0f23; 
      border: 1px solid #333;
      border-radius: 8px;
    }
    h2 { margin-bottom: 15px; font-size: 16px; color: #4fc3f7; }
    .data-item { 
      display: flex; 
      justify-content: space-between; 
      padding: 8px 0; 
      border-bottom: 1px solid #333; 
    }
    .data-key { color: #aaa; }
    .data-value { color: #4fc3f7; font-weight: bold; }
    .controls { margin-top: 20px; }
    button { 
      padding: 8px 16px; 
      margin: 5px; 
      background: #4fc3f7; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    button:hover { background: #29b6f6; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>模拟数据</h2>
      <div id="data-panel"></div>
      
      <div class="controls">
        <h2>控制</h2>
        <button onclick="randomizeData()">随机更新数据</button>
        <button onclick="startAutoUpdate()">开始自动更新</button>
        <button onclick="stopAutoUpdate()">停止自动更新</button>
      </div>
    </div>
    
    <div class="main">
      <h2>SCADA Widget 预览</h2>
      <div id="widget-container"></div>
    </div>
  </div>

  <script>
    // 模拟 TB Widget 环境
    var mockData = {
      temperature: 25.5,
      pressure: 101.3,
      flow_rate: 150,
      pump_status: 1,
      valve_position: 75
    };
    
    var autoUpdateInterval = null;
    
    // 模拟 TB Widget API
    var self = {
      ctx: {
        $container: [document.getElementById('widget-container')],
        $scope: {},
        settings: {
          scadaConfig: null  // 画面配置将从这里加载
        },
        defaultSubscription: {
          data: []
        },
        detectChanges: function() {
          console.log('detectChanges called');
        },
        controlApi: {
          sendOneWayCommand: function(method, params) {
            console.log('RPC OneWay:', method, params);
          },
          sendTwoWayCommand: function(method, params) {
            console.log('RPC TwoWay:', method, params);
            return { subscribe: function(success, error) { success({}); } };
          }
        }
      }
    };
    
    // 转换为 TB 数据格式
    function toTbDataFormat(data) {
      return Object.entries(data).map(([key, value]) => ({
        dataKey: { name: key, type: 'timeseries' },
        data: [[Date.now(), value]]
      }));
    }
    
    // 更新数据面板显示
    function updateDataPanel() {
      var html = '';
      Object.entries(mockData).forEach(([key, value]) => {
        html += '<div class="data-item">';
        html += '<span class="data-key">' + key + '</span>';
        html += '<span class="data-value">' + value + '</span>';
        html += '</div>';
      });
      document.getElementById('data-panel').innerHTML = html;
    }
    
    // 随机更新数据
    function randomizeData() {
      mockData.temperature = (20 + Math.random() * 20).toFixed(1);
      mockData.pressure = (95 + Math.random() * 15).toFixed(1);
      mockData.flow_rate = Math.floor(100 + Math.random() * 100);
      mockData.pump_status = Math.random() > 0.5 ? 1 : 0;
      mockData.valve_position = Math.floor(Math.random() * 100);
      
      // 更新 TB 数据格式
      self.ctx.defaultSubscription.data = toTbDataFormat(mockData);
      
      // 触发 Widget 数据更新
      if (typeof self.onDataUpdated === 'function') {
        self.onDataUpdated();
      }
      
      updateDataPanel();
    }
    
    // 自动更新
    function startAutoUpdate() {
      if (!autoUpdateInterval) {
        autoUpdateInterval = setInterval(randomizeData, 1000);
        console.log('Auto update started');
      }
    }
    
    function stopAutoUpdate() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
        autoUpdateInterval = null;
        console.log('Auto update stopped');
      }
    }
    
    // 初始化
    function init() {
      updateDataPanel();
      self.ctx.defaultSubscription.data = toTbDataFormat(mockData);
      
      // 加载 Widget 代码后会调用 self.onInit()
      console.log('Test page initialized. Load widget code to test.');
    }
    
    init();
  </script>
  
  <!-- Widget 代码将在这里加载 -->
  <!-- <script src="../dist/fuxa-core.js"></script> -->
  <!-- <script src="../src/widgets/scada-viewer/controller.js"></script> -->
</body>
</html>
