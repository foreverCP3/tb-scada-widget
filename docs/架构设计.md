# TB Industrial Widgets 架构设计

## 一、项目目标

在 ThingsBoard 中实现工业组态功能：
- **编辑模式**：管理员可以拖拽组装工业画面（类似 FUXA 编辑器）
- **查看模式**：普通用户看到实时渲染的监控画面（带动画、数据绑定）

## 二、核心策略

**复用 FUXA 渲染能力，通过 API 与 ThingsBoard 进行数据交互**

### 2.1 为什么复用 FUXA？

| 功能需求 | 自研工作量 | FUXA 已实现 |
|----------|-----------|-------------|
| 图元管理（直线/折线/矩形/多边形/椭圆） | 大 | ✅ |
| 控件（按钮/趋势/表格/仪表盘） | 大 | ✅ |
| 特性（变色/填充/闪烁/显示） | 中 | ✅ |
| 动画（流动/闪烁） | 中 | ✅ |
| 专用图库（工业图元） | 大 | ✅ |
| 编辑器（拖拽/属性面板/对齐） | **巨大** | ✅ |

### 2.2 功能需求清单覆盖

详见 [功能需求清单.md](./功能需求清单.md)，共 40 项功能需求，FUXA 已覆盖 80%+。

## 三、整体架构

```
┌────────────────────────────────────────────────────────────┐
│                   TB Custom Widget                          │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐  │
│  │              FUXA Engine (渲染核心)                   │  │
│  │                                                       │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  │  │
│  │  │   Editor    │  │   Viewer    │  │  图元库       │  │  │
│  │  │  (编辑器)   │  │  (查看器)   │  │  (Shapes)    │  │  │
│  │  └─────────────┘  └─────────────┘  └──────────────┘  │  │
│  │                                                       │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  │  │
│  │  │  SVG渲染    │  │   动画引擎  │  │  事件系统    │  │  │
│  │  └─────────────┘  └─────────────┘  └──────────────┘  │  │
│  └──────────────────────────────────────────────────────┘  │
│                          ▲                                  │
│                          │                                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                    Bridge API                         │  │
│  │                                                       │  │
│  │   数据接口          配置接口          事件接口        │  │
│  │   onDataUpdate()    loadConfig()     onElementClick() │  │
│  │   writeValue()      saveConfig()     onReady()        │  │
│  └──────────────────────────────────────────────────────┘  │
│                          ▲                                  │
│                          │                                  │
├────────────────────────────────────────────────────────────┤
│                   ThingsBoard Widget API                    │
│                                                             │
│   ctx.datasources      数据源订阅                           │
│   ctx.settings         Widget 配置存储                      │
│   ctx.controlApi       RPC 命令发送                         │
│   ctx.detectChanges    UI 更新通知                          │
└────────────────────────────────────────────────────────────┘
```

## 四、模块职责

### 4.1 FUXA Engine（渲染核心）

从 FUXA 项目提取的核心渲染能力：

| 模块 | 职责 |
|------|------|
| **Editor** | 拖拽编辑器、工具栏、属性面板 |
| **Viewer** | 只读渲染、运行时展示 |
| **图元库** | Shapes / Controls / Proc.Eng 等图形元素 |
| **SVG渲染** | 创建、更新、删除 SVG 元素 |
| **动画引擎** | 流动、闪烁、填充等动画效果 |
| **事件系统** | 元素点击、悬停等交互事件 |

### 4.2 Bridge API（桥接层）

连接 FUXA 和 ThingsBoard 的中间层：

```typescript
interface TbScadaApi {
  // ===== 数据交互 =====
  
  /** TB 数据更新时调用，推送到 FUXA */
  onDataUpdate(callback: (data: Record<string, any>) => void): void;
  
  /** FUXA 写值，发送到 TB */
  writeValue(tagName: string, value: any): Promise<void>;
  
  /** 批量写值 */
  writeValues(values: Record<string, any>): Promise<void>;

  // ===== 配置管理 =====
  
  /** 加载画面配置 */
  loadConfig(config: ScadaConfig): void;
  
  /** 导出当前配置 */
  exportConfig(): ScadaConfig;

  // ===== 事件回调 =====
  
  /** 元素点击事件 */
  onElementClick(callback: (elementId: string, event: any) => void): void;
  
  /** 画面加载完成 */
  onReady(callback: () => void): void;

  // ===== 模式控制 =====
  
  /** 切换模式 */
  setMode(mode: 'editor' | 'viewer'): void;
  
  /** 获取当前模式 */
  getMode(): 'editor' | 'viewer';
}
```

### 4.3 ThingsBoard Widget 集成

```javascript
// Widget Controller
self.onInit = function() {
  // 1. 初始化 FUXA 引擎
  const scada = new TbScada(self.ctx.$container[0], {
    mode: self.ctx.settings.mode || 'viewer',
    config: self.ctx.settings.scadaConfig
  });

  // 2. TB 数据 → FUXA 渲染
  self.ctx.defaultSubscription.subscribeForDatasetUpdates(data => {
    scada.updateData(transformTbDataToFuxa(data));
  });

  // 3. FUXA 写值 → TB RPC
  scada.onWriteValue((tag, value) => {
    self.ctx.controlApi.sendTwoWayCommand('setValue', { tag, value });
  });

  // 4. 编辑器模式：保存配置到 Widget Settings
  if (self.ctx.settings.mode === 'editor') {
    scada.onConfigChange(config => {
      self.ctx.settings.scadaConfig = config;
      self.ctx.updateWidgetConfig(self.ctx.settings);
    });
  }
};

// 数据更新回调
self.onDataUpdated = function() {
  const data = self.ctx.data;
  scada.updateData(transformTbDataToFuxa(data));
};

// 销毁
self.onDestroy = function() {
  scada.destroy();
};
```

## 五、数据流设计

### 5.1 编辑时数据流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────────────┐
│   用户操作   │ ──▶ │ FUXA Editor │ ──▶ │ JSON Config         │
│  (拖拽/配置) │     │             │     │ (画面配置)          │
└─────────────┘     └─────────────┘     └──────────┬──────────┘
                                                    │
                                                    ▼
                                        ┌─────────────────────┐
                                        │ TB Widget Settings  │
                                        │ 或 Entity Attribute │
                                        └─────────────────────┘
```

### 5.2 运行时数据流

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────┐
│ TB Telemetry    │ ──▶ │ Bridge API      │ ──▶ │ FUXA Viewer │
│ (实时数据)      │     │ (数据转换)      │     │ (SVG渲染)   │
└─────────────────┘     └─────────────────┘     └─────────────┘
                                                       │
                                                       ▼
                                               ┌─────────────┐
                                               │  用户看到    │
                                               │  实时画面    │
                                               └─────────────┘
```

### 5.3 交互数据流（写值）

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 用户点击    │ ──▶ │ FUXA 事件   │ ──▶ │ Bridge API  │ ──▶ │ TB RPC      │
│ 按钮/开关   │     │             │     │ writeValue  │     │ 发送命令    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

## 六、配置数据结构

### 6.1 画面配置 (ScadaConfig)

```typescript
interface ScadaConfig {
  /** 画面基本信息 */
  id: string;
  name: string;
  width: number;
  height: number;
  backgroundColor: string;

  /** 图元列表 */
  elements: ScadaElement[];

  /** 数据绑定规则 */
  bindings: DataBinding[];

  /** 动画配置 */
  animations: AnimationConfig[];
}

interface ScadaElement {
  id: string;
  type: string;           // 'rect' | 'pipe' | 'valve' | 'gauge' | ...
  x: number;
  y: number;
  width?: number;
  height?: number;
  rotation?: number;
  properties: Record<string, any>;  // 元素特有属性
  style: ElementStyle;
}

interface DataBinding {
  elementId: string;
  property: string;       // 要绑定的属性 'fill' | 'value' | 'visible' | ...
  dataKey: string;        // TB 数据键
  transform?: string;     // 转换表达式 "value > 50 ? 'red' : 'green'"
}

interface AnimationConfig {
  elementId: string;
  type: 'flow' | 'blink' | 'fill' | 'rotate';
  trigger?: {
    dataKey: string;
    condition: string;    // "value > 0"
  };
  options: Record<string, any>;
}
```

### 6.2 TB 数据格式转换

```typescript
// TB 原始数据格式
interface TbDataUpdate {
  datasource: {
    entityId: string;
    entityType: string;
  };
  data: {
    [key: string]: [timestamp: number, value: any][];
  };
}

// 转换为 FUXA 格式
function transformTbDataToFuxa(tbData: TbDataUpdate): Record<string, any> {
  const result: Record<string, any> = {};
  
  for (const [key, values] of Object.entries(tbData.data)) {
    // 取最新值
    if (values.length > 0) {
      result[key] = values[values.length - 1][1];
    }
  }
  
  return result;
}
```

## 七、最终集成方案

基于 FUXA 源码分析（详见 [FUXA源码分析.md](./FUXA源码分析.md)）和 TB Widget 机制分析（详见 [TB-Widget开发指南.md](./TB-Widget开发指南.md)），确定最终方案。

### 7.1 方案选择：源码级嵌入

**核心思路：** 将 FUXA 的 UI 渲染代码直接复制到 TB Widget 中，因为 TB Widget 原生支持 Angular 语法。

```
FUXA 源码                              TB Custom Widget
    │                                        │
    │  FuxaViewComponent                     │
    │  GaugesManager                         │
    │  图元类 (Shapes/Pipe/...)              │
    │  动画引擎                              │
    │           │                            │
    │           │ 复制 + 适配                │
    │           ▼                            │
    │    ┌─────────────────────┐            │
    └───►│  Widget JavaScript   │◄───────────┘
          │  + HTML (Angular)   │
          │  + CSS              │
          └─────────────────────┘
```

**选择理由：**
1. **TB 原生支持 Angular** - Widget 的 HTML 支持 `*ngFor`、`{{}}` 等语法
2. **无需改 TB 源码** - 纯 Widget 层面实现
3. **FUXA 功能完整** - 渲染、动画、图元全部可用
4. **开发效率高** - 复用 > 重写

### 7.2 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                   TB Dashboard                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              SCADA Widget (Custom Widget)              │  │
│  │                                                        │  │
│  │  ┌──────────────────────────────────────────────────┐ │  │
│  │  │                    HTML                           │ │  │
│  │  │  <app-fuxa-view [view]="view" [hmi]="hmi">       │ │  │
│  │  │  </app-fuxa-view>                                │ │  │
│  │  │                                                   │ │  │
│  │  │  支持 Angular 语法: *ngFor, *ngIf, [(ngModel)]   │ │  │
│  │  └──────────────────────────────────────────────────┘ │  │
│  │                                                        │  │
│  │  ┌──────────────────────────────────────────────────┐ │  │
│  │  │                 JavaScript                        │ │  │
│  │  │                                                   │ │  │
│  │  │  self.onInit = function() {                      │ │  │
│  │  │    // 初始化 FUXA 渲染                           │ │  │
│  │  │    loadFuxaView(self.ctx.$container[0]);         │ │  │
│  │  │  }                                               │ │  │
│  │  │                                                   │ │  │
│  │  │  self.onDataUpdated = function() {               │ │  │
│  │  │    // TB 数据 → FUXA 变量                        │ │  │
│  │  │    updateFuxaVariables(self.ctx.data);           │ │  │
│  │  │  }                                               │ │  │
│  │  └──────────────────────────────────────────────────┘ │  │
│  │                                                        │  │
│  │  ┌──────────────────────────────────────────────────┐ │  │
│  │  │                 Resources                         │ │  │
│  │  │  - svg.js (SVG 操作库)                           │ │  │
│  │  │  - fuxa-gauges.js (图元类打包)                   │ │  │
│  │  └──────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────┘  │
│                              ▲                               │
│                              │                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   TB Widget API                        │  │
│  │  self.ctx.data              - 订阅的遥测数据          │  │
│  │  self.ctx.settings          - Widget 配置 (含画面JSON) │  │
│  │  self.ctx.controlApi        - RPC 命令发送            │  │
│  │  self.ctx.$container        - DOM 容器                │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 需要从 FUXA 提取的代码

| 文件/模块 | 用途 | 处理方式 |
|-----------|------|----------|
| `_models/hmi.ts` | 数据模型 | 直接复用 |
| `fuxa-view/fuxa-view.component.ts` | SVG 渲染 | 适配后复用 |
| `gauges/gauges.component.ts` | 图元管理器 | 直接复用 |
| `gauges/gauge-base/` | 图元基类 | 直接复用 |
| `gauges/shapes/` | 通用图形 | 直接复用 |
| `gauges/controls/pipe/` | 管道 (流动动画) | 直接复用 |
| `gauges/controls/value/` | 数值显示 | 直接复用 |
| `_helpers/svg-utils.ts` | SVG 工具 | 直接复用 |
| `assets/lib/svg/svg.js` | SVG.js 库 | 作为 Resource 引入 |
| `_services/hmi.service.ts` | 数据通信 | **重写** (对接 TB) |

### 7.4 需要重写的部分

只需要重写 **数据通信层**：

```typescript
// 原 FUXA: 使用 Socket.io
@Injectable()
export class HmiService {
  socket: SocketIO;
  onVariableChanged: EventEmitter<Variable>;
  
  // 从服务器接收数据
  onSocketMessage(data) {
    this.onVariableChanged.emit(data);
  }
}

// 新 TB 适配: 使用 TB Widget API
export class TbHmiService {
  onVariableChanged: EventEmitter<Variable>;
  
  // 从 TB 接收数据
  updateFromTb(tbData: any[]) {
    tbData.forEach(item => {
      const variable = {
        id: item.dataKey.name,
        value: item.data[0]?.[1]
      };
      this.onVariableChanged.emit(variable);
    });
  }
}
```

### 7.5 Widget 与 FUXA 的数据流

```
TB 设备遥测
     │
     ▼
self.ctx.defaultSubscription.data
     │
     ▼
self.onDataUpdated() 触发
     │
     ▼
TbHmiService.updateFromTb()
     │
     ▼
onVariableChanged.emit(variable)
     │
     ▼
GaugesManager.processValue()
     │
     ▼
各图元类.processValue() 更新 SVG
     │
     ▼
用户看到实时画面
```

## 八、实现计划

### 阶段一：分析与设计 ✅

- [x] 分析 FUXA 前端架构
- [x] 分析 TB Widget 机制
- [x] 确定集成方案
- [x] 设计数据流

### 阶段二：FUXA 代码提取与打包

- [ ] 提取核心渲染代码 (fuxa-view, gauges, models)
- [ ] 移除 Angular DI 依赖，改为静态方法调用
- [ ] 打包成独立 JS 文件 (fuxa-core.js)
- [ ] 引入 SVG.js 等依赖

### 阶段三：TB 适配层

- [ ] 实现 TbHmiService (替代 Socket.io)
- [ ] 实现 TB 数据 → FUXA 变量转换
- [ ] 实现 FUXA 事件 → TB RPC 转换

### 阶段四：Widget 开发

- [ ] ScadaViewer Widget (只读渲染)
- [ ] ScadaEditor Widget (可视化编辑)
- [ ] Settings Schema (配置表单)

### 阶段五：测试与完善

- [ ] 集成测试
- [ ] 性能优化
- [ ] 文档完善
- [ ] 补充储能专用图元

## 九、目录结构（规划）

基于推荐方案，调整目录结构：

```
packages/
├── fuxa-core/                  # FUXA 核心模块 (从 FUXA 提取)
│   ├── src/
│   │   ├── models/             # 数据模型 (hmi.ts, device.ts)
│   │   ├── gauges/             # 图元系统
│   │   │   ├── gauge-base/
│   │   │   ├── shapes/
│   │   │   ├── controls/
│   │   │   └── gauges.manager.ts
│   │   ├── view/               # FuxaViewComponent
│   │   ├── editor/             # EditorComponent [可选]
│   │   ├── helpers/            # 工具函数
│   │   └── index.ts
│   ├── assets/
│   │   └── lib/                # SVG.js, svgeditor 等
│   └── package.json
│
├── tb-adapter/                 # ThingsBoard 适配层
│   ├── src/
│   │   ├── services/
│   │   │   ├── tb-hmi.service.ts      # 替代 FUXA HmiService
│   │   │   └── tb-project.service.ts  # 配置存储
│   │   ├── utils/
│   │   │   └── data-transformer.ts    # TB → FUXA 数据转换
│   │   └── index.ts
│   └── package.json
│
└── widgets/                    # TB Widget 封装
    ├── src/
    │   ├── scada-viewer/       # 查看器 Widget
    │   │   ├── scada-viewer.component.ts
    │   │   └── scada-viewer.module.ts
    │   ├── scada-editor/       # 编辑器 Widget
    │   │   ├── scada-editor.component.ts
    │   │   └── scada-editor.module.ts
    │   └── index.ts
    └── package.json
```

## 十、UI 主题对齐方案

### 10.1 FUXA 主题机制分析

FUXA 使用两层主题系统：

**1. CSS 变量 (运行时切换)**
```typescript
// theme.config.ts - 定义了 40+ CSS 变量
export const THEMES = {
  default: {
    headerBackground: 'hsl(0, 0%, 100%)',
    toolboxBackground: '#FBFBFB',
    formInputBackground: '#f1f3f4',
    // ...
  },
  dark: {
    headerBackground: '#333333',
    toolboxBackground: '#252526',
    formInputBackground: '#37373D',
    // ...
  }
};

// ThemeService - 通过 CSS 变量注入
setTheme(name) {
  Object.keys(theme).forEach((key) => {
    document.documentElement.style.setProperty(`--${key}`, theme[key]);
  });
}
```

**2. Angular Material 主题 (编译时)**
```scss
// theme.scss - Material 组件主题
$dark-theme: mat.define-dark-theme(...);
.dark-theme {
  @include mat.all-legacy-component-themes($dark-theme);
}
```

### 10.2 与 ThingsBoard 主题对齐策略

**TB 也使用 Angular Material + CSS 变量**，对齐方案如下：

| FUXA 主题元素 | TB 对齐方式 | 难度 |
|--------------|------------|------|
| CSS 变量 (40+) | 映射到 TB CSS 变量 | 低 |
| Material 组件 | 复用 TB 的 Material 主题 | 低 |
| 编辑器 UI | 自定义 CSS 覆盖 | 中 |
| SVG 画布 | 独立，不影响 | 无 |

### 10.3 实现方式

**方案：创建 TB 主题适配层**

```typescript
// tb-theme-adapter.ts
export class TbThemeAdapter {
  
  // TB CSS 变量 → FUXA CSS 变量 映射
  private static readonly TB_TO_FUXA_MAP = {
    // TB 变量名          → FUXA 变量名
    '--tb-primary-color': 'toolboxItemActiveBackground',
    '--tb-background':    'headerBackground',
    '--tb-surface':       'toolboxBackground',
    '--tb-text-primary':  'headerColor',
    // ...
  };
  
  /** 从 TB 读取主题并应用到 FUXA */
  static applyTbThemeToFuxa() {
    const tbStyles = getComputedStyle(document.documentElement);
    
    Object.entries(this.TB_TO_FUXA_MAP).forEach(([tbVar, fuxaVar]) => {
      const value = tbStyles.getPropertyValue(tbVar);
      if (value) {
        document.documentElement.style.setProperty(`--${fuxaVar}`, value);
      }
    });
  }
  
  /** 监听 TB 主题切换 */
  static watchTbThemeChange(callback: () => void) {
    // 监听 body class 变化 (dark-theme)
    const observer = new MutationObserver(() => {
      this.applyTbThemeToFuxa();
      callback();
    });
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  }
}
```

### 10.4 主题对齐范围

| 组件 | 是否对齐 TB | 说明 |
|------|------------|------|
| **编辑器 UI** (工具栏/面板) | ✅ 是 | 通过 CSS 变量映射 |
| **SVG 画布背景** | ⚠️ 可选 | 用户可自定义 |
| **图元样式** | ❌ 否 | 由用户在编辑器中配置 |
| **Material 组件** | ✅ 是 | 复用 TB 的 Material 主题 |

### 10.5 预期效果

```
TB 浅色主题 → FUXA 编辑器浅色 UI
TB 深色主题 → FUXA 编辑器深色 UI
                ↓
        SVG 画布内容不受影响
        (用户自己配置画面颜色)
```

## 十二、风险与应对

| 风险 | 影响 | 应对策略 |
|------|------|----------|
| FUXA 深度耦合 Angular | 提取困难 | 评估后可能需要 iframe 嵌入方案 |
| 渲染性能问题 | 大型画面卡顿 | 虚拟化、懒加载 |
| TB Widget 限制 | 功能受限 | 充分测试 TB Widget API |
| 配置数据过大 | 存储/加载慢 | 配置压缩、分片存储 |

## 十三、参考资源

- FUXA 源码：`/FUXA/` 目录
- FUXA 文档：https://github.com/frangoteam/FUXA/wiki
- TB Widget 开发：https://thingsboard.io/docs/user-guide/contribution/widgets-development/
- 功能需求清单：[功能需求清单.md](./功能需求清单.md)
